package io.adobe

import com.google.protobuf.ByteString
import org.scalatest.FunSuite

class XORChunkIteratorTest extends FunSuite {

  test("testNext") {

    val stream: Array[Byte] = Array(-30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, 64, 7, -81, -8,
      -112, 3, -53, -2, 36, 0, -6, -1, -59, 127, -2, -65, -1, 95, -8, -94, 39, 86, -40, -56, 10, -59, -1, -110, 0, -128)
//    val streamModified = stream.map(x => x & 0xff)
    val bytes: ByteString = ByteString.copyFrom(stream)
    val iterator = new XORChunkIterator(bytes.toByteArray)
    iterator.next()
    assert((1604016580657L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016581657L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016582672L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016583657L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016584672L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016585657L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016586673L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016587674L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016588674L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016589673L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016590657L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016593846L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016594673L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016595672L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016596657L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016597674L, 1.0) == (iterator.t, iterator.v))
  }

  test("testNext2") {

    val stream: Array[Byte] = Array(-112, -16, -109, -88, -81, 93, 127, -16, 0, 0, 0, 0, 0, 2, -22, -116, 33, -61, -12,
      0, 0, 0, 0, 0, 0, 0, 63, -1, -1, -1, -1, -1, -17, -124, 68, -125, -92, 91, -37, 32, -6, -41, -125, 11, -1, -60, 0,
      34, -1, -4, 76, 14, -48, 0, 0, 0, 0, 0, 0, 0, -28, -64, -91, 0, 0, 0, 0, 0, 0, 0, 14, -89, 93, 32, 69, 69, -1, -6,
      0, 9, 127, -2, 2, -1, -3, 0, 6, -65, -3, 64, 0, -96, 0, 87, -1, -56, 0, 37, -1, -6, -1, -3, 0, 4, -65, -1, 28, 51,
      121, -76, 0, 0, 0, 0, 0, 0, 0, 61, -49, -4, -108, 0, 0, 0, 0, 0, 0, 0, 52, 74, 9, 2, 21, -104, 90, -20, -11, 7,
      44, -65, -1, 65, -11, 47, 5, 80, 125, -117, -63, 97, 0, 2, -65, -2, 64, 1, 47, -1, 80, 0, 66, 0, 5, 127, -4, -128,
      2, 95, -1, 32, -6, -105, -126, -55, -105, -118, 0, 0, 0, 0, 0, 0, 0, 16)

    //    val streamModified = stream.map(x => x & 0xff)
    val bytes: ByteString = ByteString.copyFrom(stream)
    val iterator = new XORChunkIterator(bytes.toByteArray)
    while (iterator.hasNext) {
      iterator.next()
      println(iterator.t, iterator.v)
    }

  }

  test("testIncreasing") {

    val stream: Array[Byte] = Array(-30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128,
      15, -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22,
      19, -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0,
      0, 0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1,
      -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96,
      -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10,
      -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23,
      1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15,
      -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19,
      -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0,
      0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1,
      -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96,
      -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10,
      -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23,
      1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15,
      -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19,
      -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0,
      0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1,
      -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96,
      -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10,
      -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23,
      1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15,
      -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19,
      -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0,
      0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1,
      -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96,
      -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10,
      -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23,
      1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15,
      -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19,
      -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0,
      0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1,
      -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0, -30, -96,
      -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15, -40, 14, -1, -117, 88, 92, 0, -10,
      -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19, -30, 39, 119, 3, -74, -58, -38, 23,
      1, 88, -65, -14, 64, 16, 0, -30, -96, -75, -19, -82, 93, 63, -16, 0, 0, 0, 0, 0, 0, -24, 7, -62, 95, -1, -128, 15,
      -40, 14, -1, -117, 88, 92, 0, -10, -48, 119, -4, 72, 1, -11, -1, -118, -1, -1, 96, 93, -1, -4, -33, -8, -22, 19,
      -30, 39, 119, 3, -74, -58, -38, 23, 1, 88, -65, -14, 64, 16, 0)

    //    val streamModified = stream.map(x => x & 0xff)
    val bytes: ByteString = ByteString.copyFrom(stream)
    val iterator = new XORChunkIterator(bytes.toByteArray)
    iterator.next()
    assert((1604016580657L, 1.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016581657L, 2.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016582672L, 3.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016583657L, 4.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016584672L, 5.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016585657L, 5.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016586673L, 5.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016587674L, 5.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016588674L, 6.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016589673L, 7.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016590657L, 8.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016593846L, 9.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016594673L, 10.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016595672L, 10.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016596657L, 10.0) == (iterator.t, iterator.v))
    iterator.next()
    assert((1604016597674L, 10.0) == (iterator.t, iterator.v))
  }

}
